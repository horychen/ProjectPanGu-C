#include "ACMSim.h"
#include "Bezier.h"

/* 管仲焘在用的东西 */
BezierController BzController;


int CombTable[10][10] = {
    {1},
    {1, 1},
    {1, 2, 1},
    {1, 3, 3, 1},
    {1, 4, 6, 4, 1},
    {1, 5, 10, 10, 5, 1},
    {1, 6, 15, 20, 15, 6, 1},
    {1, 7, 21, 35, 35, 21, 7, 1},
    {1, 8, 28, 56, 70, 56, 28, 8, 1},
    {1, 9, 36, 84, 126, 126, 84, 36, 9, 1}};

int Comb(const int n, const int m)
{
    return CombTable[n][m];
}

#define BEZIER_NUMBER_OF_POINTS (d_sim.user.bezier_order + 1)

/**
 * @struct FindTParams
 * @brief Structure representing the parameters for finding the value of t in a Bezier curve.
 *
 * This structure holds a pointer to a BezierController object and the target x-coordinate value.
 * It is used to pass the necessary parameters for finding the value of t that corresponds to a given x-coordinate
 * on a Bezier curve.
 */
typedef struct
{
    const BezierController *BzierController; ///< Pointer to a BezierController object.
    REAL target_x;                           ///< Target x-coordinate value.
} FindTParams;

/**
 * @brief Calculates the binomial coefficient
 * @param n The total number of elements
 * @param m The number of elements to choose
 * @return The binomial coefficient
 */

// int Comb(const int n, const int m)
// {
//     if (m == 0 || m == n)
//         return 1;
//     return Comb(n - 1, m) + Comb(n - 1, m - 1);
// }
Bezier_MAP_TABLE err_index_map_table = {
    .x = {0.0, 1.9666040140801624, 3.9332080281603248, 5.899812042240487, 7.8664160563206496, 9.833020070400812, 11.799624084480975, 13.766228098561136, 15.732832112641299, 17.699436126721462, 19.666040140801623, 21.632644154881785, 23.59924816896195, 25.56585218304211, 27.532456197122272, 29.499060211202437, 31.465664225282598, 33.43226823936276, 35.398872253442924, 37.365476267523086, 39.33208028160325, 41.29868429568341, 43.26528830976357, 45.23189232384374, 47.1984963379239, 49.16510035200406, 51.13170436608422, 53.09830838016438, 55.064912394244544, 57.03151640832471, 58.998120422404874, 60.964724436485035, 62.931328450565196, 64.89793246464536, 66.86453647872553, 68.83114049280569, 70.79774450688585, 72.76434852096601, 74.73095253504617, 76.69755654912633, 78.6641605632065, 80.63076457728666, 82.59736859136682, 84.56397260544698, 86.53057661952714, 88.49718063360731, 90.46378464768748, 92.43038866176764, 94.3969926758478, 96.36359668992796, 98.33020070400812, 100.29680471808828, 102.26340873216844, 104.2300127462486, 106.19661676032877, 108.16322077440893, 110.12982478848909, 112.09642880256925, 114.06303281664943, 116.02963683072959, 117.99624084480975, 119.96284485888991, 121.92944887297007, 123.89605288705023, 125.86265690113039, 127.82926091521055, 129.79586492929073, 131.7624689433709, 133.72907295745105, 135.6956769715312, 137.66228098561137, 139.62888499969154, 141.5954890137717, 143.56209302785186, 145.52869704193202, 147.49530105601218, 149.46190507009234, 151.4285090841725, 153.39511309825266, 155.36171711233283, 157.328321126413, 159.29492514049315, 161.2615291545733, 163.22813316865347, 165.19473718273363, 167.1613411968138, 169.12794521089396, 171.09454922497412, 173.06115323905428, 175.02775725313444, 176.99436126721463, 178.9609652812948, 180.92756929537495, 182.8941733094551, 184.86077732353527, 186.82738133761544, 188.7939853516956, 190.76058936577576, 192.72719337985592, 194.69379739393608, 196.66040140801624, 198.6270054220964, 200.59360943617656, 202.56021345025673, 204.5268174643369, 206.49342147841705, 208.4600254924972, 210.42662950657737, 212.39323352065753, 214.3598375347377, 216.32644154881785, 218.29304556289802, 220.25964957697818, 222.22625359105834, 224.1928576051385, 226.15946161921866, 228.12606563329885, 230.092669647379, 232.05927366145917, 234.02587767553933, 235.9924816896195, 237.95908570369966, 239.92568971777982, 241.89229373185998, 243.85889774594014, 245.8255017600203, 247.79210577410046, 249.75870978818062, 251.72531380226079, 253.69191781634095, 255.6585218304211, 257.62512584450127, 259.59172985858146, 261.5583338726616, 263.5249378867418, 265.4915419008219, 267.4581459149021, 269.42474992898224, 271.3913539430624, 273.35795795714256, 275.32456197122275, 277.2911659853029, 279.2577699993831, 281.2243740134632, 283.1909780275434, 285.1575820416235, 287.1241860557037, 289.09079006978385, 291.05739408386404, 293.0239980979442, 294.99060211202436, 296.9572061261045, 298.9238101401847, 300.8904141542648, 302.857018168345, 304.8236221824252, 306.79022619650533, 308.7568302105855, 310.72343422466565, 312.69003823874584, 314.656642252826, 316.62324626690616, 318.5898502809863, 320.5564542950665, 322.5230583091466, 324.4896623232268, 326.45626633730694, 328.42287035138713, 330.38947436546727, 332.35607837954745, 334.3226823936276, 336.2892864077078, 338.2558904217879, 340.2224944358681, 342.18909844994823, 344.1557024640284, 346.12230647810856, 348.08891049218875, 350.0555145062689, 352.02211852034907, 353.98872253442926, 355.9553265485094, 357.9219305625896, 359.8885345766697, 361.8551385907499, 363.82174260483004, 365.7883466189102, 367.75495063299036, 369.72155464707055, 371.6881586611507, 373.65476267523087, 375.621366689311, 377.5879707033912, 379.5545747174713, 381.5211787315515, 383.48778274563165, 385.45438675971184, 387.42099077379197, 389.38759478787216, 391.3541988019523},
    .y = {-1.5906839414748505e-18, 0.03030220452668008, 0.06394641073272332, 0.1023753254170341, 0.1475194437306186, 0.20060077279242497, 0.25732539707664936, 0.3075423860830501, 0.3472322648404012, 0.3785313135829393, 0.4040410375599034, 0.42552668027123597, 0.4441065491835565, 0.4605051955331495, 0.4752108432612336, 0.4885654504669324, 0.5008168753720036, 0.5121501396033386, 0.5227068784534837, 0.5325978783653212, 0.5419114219693634, 0.5507190036333863, 0.5590793445425852, 0.5670412773878318, 0.5746458608047113, 0.5819279571958432, 0.5889174291574779, 0.5956400599162388, 0.6021182707573366, 0.6083716869054068, 0.6144175887319144, 0.6202712751128705, 0.6259463587181682, 0.6314550080058273, 0.6368081470836241, 0.6420156219637698, 0.6470863397878559, 0.6520283861435928, 0.656849124496111, 0.6615552809192976, 0.6661530166688362, 0.6706479906394334, 0.6750454133585937, 0.6793500938621513, 0.6835664805532006, 0.687698696951909, 0.6917505730872615, 0.6957256731558419, 0.6996273199705684, 0.7034586166382508, 0.707222465836356, 0.710921587002681, 0.7145585317046939, 0.7181356974162317, 0.7216553398966005, 0.7251195843397161, 0.7285304354378599, 0.7318897864851042, 0.7351994276289181, 0.7384610533643742, 0.741676269353344, 0.7448465986407651, 0.7479734873312069, 0.7510583097813301, 0.754102373357244, 0.7571069228000488, 0.7600731442378948, 0.7630021688785616, 0.7658950764127955, 0.7687528981553393, 0.7715766199478461, 0.774367184844482, 0.7771254956006898, 0.7798524169805483, 0.7825487779042731, 0.7852153734351247, 0.7878529666382467, 0.7904622903078283, 0.7930440485789019, 0.7955989184321136, 0.7981275510999427, 0.800630573382063, 0.8031085888768513, 0.8055621791354182, 0.8079919047439769, 0.8103983063398631, 0.812781905566059, 0.8151432059686646, 0.8174826938413905, 0.8198008390208056, 0.8220980956357699, 0.8243749028142067, 0.8266316853501149, 0.8288688543334954, 0.8310868077456552, 0.8332859310221652, 0.8354665975855716, 0.8376291693498064, 0.8397739971980924, 0.8419014214360115, 0.8440117722211589, 0.8461053699715947, 0.8481825257522928, 0.8502435416439738, 0.8522887110928116, 0.8543183192433098, 0.8563326432551006, 0.8583319526045957, 0.860316509372358, 0.8622865685170038, 0.8642423781363905, 0.8661841797168237, 0.8681122083707858, 0.8700266930642243, 0.8719278568333815, 0.873815916992193, 0.8756910853305535, 0.8775535683039667, 0.8794035672150273, 0.8812412783871593, 0.8830668933310026, 0.8848805989038259, 0.8866825774623116, 0.8884730070090475, 0.8902520613330319, 0.8920199101444897, 0.8937767192042727, 0.8955226504481066, 0.8972578621059313, 0.8989825088165644, 0.900696741737912, 0.9024007086529306, 0.9040945540715386, 0.9057784193286622, 0.9074524426785929, 0.9091167593858224, 0.9107715018125121, 0.9124167995027488, 0.9140527792637261, 0.9156795652439881, 0.917297279008862, 0.9189060396132006, 0.920505963671552, 0.922097165425862, 0.9236797568108175, 0.9252538475169274, 0.9268195450514343, 0.9283769547971495, 0.9299261800692936, 0.931467322170425, 0.9330004804435341, 0.9345257523233755, 0.9360432333863415, 0.9375530173977934, 0.9390551963581165, 0.9405498605516374, 0.9420370985840317, 0.9435169974284588, 0.9449896424653612, 0.9464551175219824, 0.9479135049106507, 0.9493648854658764, 0.950809338580305, 0.9522469422395703, 0.9536777730560869, 0.9551019063018221, 0.9565194159400829, 0.9579303746563542, 0.9593348538882231, 0.9607329238544207, 0.962124653583013, 0.9635101109387719, 0.9648893626497531, 0.9662624743331104, 0.9676295105201714, 0.9689905346808013, 0.9703456092470777, 0.9716947956363009, 0.9730381542733624, 0.9743757446124911, 0.9757076251584008, 0.9770338534868573, 0.9783544862646838, 0.979669579269224, 0.9809791874077083, 0.9822833647332487, 0.9835821644683986, 0.9848756390160234, 0.9861638399802638, 0.9874468181821, 0.9887246236754809, 0.9899973057630349, 0.991264913011374, 0.9925274932660032, 0.9937850936658509, 0.9950377606574287, 0.996285540008997, 0.9975284768222364, 0.9987666155488429, 0.9999999999999521},
    .upper = 391.3541988019523 
};
Bezier_MAP_TABLE index_out_map_table= {
    .x = {0.0, 0.005025125628140704, 0.010050251256281407, 0.01507537688442211, 0.020100502512562814, 0.02512562814070352, 0.03015075376884422, 0.035175879396984924, 0.04020100502512563, 0.04522613065326633, 0.05025125628140704, 0.05527638190954774, 0.06030150753768844, 0.06532663316582915, 0.07035175879396985, 0.07537688442211056, 0.08040201005025126, 0.08542713567839195, 0.09045226130653267, 0.09547738693467336, 0.10050251256281408, 0.10552763819095477, 0.11055276381909548, 0.11557788944723618, 0.12060301507537688, 0.12562814070351758, 0.1306532663316583, 0.135678391959799, 0.1407035175879397, 0.1457286432160804, 0.15075376884422112, 0.15577889447236182, 0.16080402010050251, 0.1658291457286432, 0.1708542713567839, 0.17587939698492464, 0.18090452261306533, 0.18592964824120603, 0.19095477386934673, 0.19597989949748745, 0.20100502512562815, 0.20603015075376885, 0.21105527638190955, 0.21608040201005024, 0.22110552763819097, 0.22613065326633167, 0.23115577889447236, 0.23618090452261306, 0.24120603015075376, 0.24623115577889448, 0.25125628140703515, 0.2562814070351759, 0.2613065326633166, 0.2663316582914573, 0.271356783919598, 0.2763819095477387, 0.2814070351758794, 0.2864321608040201, 0.2914572864321608, 0.2964824120603015, 0.30150753768844224, 0.3065326633165829, 0.31155778894472363, 0.3165829145728643, 0.32160804020100503, 0.32663316582914576, 0.3316582914572864, 0.33668341708542715, 0.3417085427135678, 0.34673366834170855, 0.35175879396984927, 0.35678391959798994, 0.36180904522613067, 0.36683417085427134, 0.37185929648241206, 0.3768844221105528, 0.38190954773869346, 0.3869346733668342, 0.3919597989949749, 0.3969849246231156, 0.4020100502512563, 0.40703517587939697, 0.4120603015075377, 0.4170854271356784, 0.4221105527638191, 0.4271356783919598, 0.4321608040201005, 0.4371859296482412, 0.44221105527638194, 0.4472361809045226, 0.45226130653266333, 0.457286432160804, 0.4623115577889447, 0.46733668341708545, 0.4723618090452261, 0.47738693467336685, 0.4824120603015075, 0.48743718592964824, 0.49246231155778897, 0.49748743718592964, 0.5025125628140703, 0.507537688442211, 0.5125628140703518, 0.5175879396984925, 0.5226130653266332, 0.5276381909547738, 0.5326633165829145, 0.5376884422110553, 0.542713567839196, 0.5477386934673367, 0.5527638190954774, 0.5577889447236181, 0.5628140703517588, 0.5678391959798995, 0.5728643216080402, 0.577889447236181, 0.5829145728643216, 0.5879396984924623, 0.592964824120603, 0.5979899497487438, 0.6030150753768845, 0.6080402010050251, 0.6130653266331658, 0.6180904522613065, 0.6231155778894473, 0.628140703517588, 0.6331658291457286, 0.6381909547738693, 0.6432160804020101, 0.6482412060301508, 0.6532663316582915, 0.6582914572864321, 0.6633165829145728, 0.6683417085427136, 0.6733668341708543, 0.678391959798995, 0.6834170854271356, 0.6884422110552764, 0.6934673366834171, 0.6984924623115578, 0.7035175879396985, 0.7085427135678392, 0.7135678391959799, 0.7185929648241206, 0.7236180904522613, 0.7286432160804021, 0.7336683417085427, 0.7386934673366834, 0.7437185929648241, 0.7487437185929648, 0.7537688442211056, 0.7587939698492463, 0.7638190954773869, 0.7688442211055276, 0.7738693467336684, 0.7788944723618091, 0.7839195979899498, 0.7889447236180904, 0.7939698492462312, 0.7989949748743719, 0.8040201005025126, 0.8090452261306533, 0.8140703517587939, 0.8190954773869347, 0.8241206030150754, 0.8291457286432161, 0.8341708542713568, 0.8391959798994975, 0.8442211055276382, 0.8492462311557789, 0.8542713567839196, 0.8592964824120604, 0.864321608040201, 0.8693467336683417, 0.8743718592964824, 0.8793969849246231, 0.8844221105527639, 0.8894472361809045, 0.8944723618090452, 0.8994974874371859, 0.9045226130653267, 0.9095477386934674, 0.914572864321608, 0.9195979899497487, 0.9246231155778895, 0.9296482412060302, 0.9346733668341709, 0.9396984924623115, 0.9447236180904522, 0.949748743718593, 0.9547738693467337, 0.9597989949748744, 0.964824120603015, 0.9698492462311558, 0.9748743718592965, 0.9798994974874372, 0.9849246231155779, 0.9899497487437187, 0.9949748743718593, 1.0},
    .y = {0.0, 0.011528133116934715, 0.02632906873985236, 0.044331774976776935, 0.06546512456985094, 0.08965791429233433, 0.1168388843456032, 0.14693673775614885, 0.17988015977257643, 0.21559783726260384, 0.25401847811006056, 0.29507083061188644, 0.33868370287513067, 0.3847859822139507, 0.4333066545466104, 0.48417482379248006, 0.5373197312690338, 0.59267077508885, 0.6501575295566095, 0.7097097645660927, 0.7712574649971818, 0.8347308501128566, 0.900060392956195, 0.9671768397473717, 1.0360112292806554, 1.106494912321411, 1.178559571003095, 1.2521372382242548, 1.3271603170455313, 1.4035616000866522, 1.4812742889234347, 1.5602320134847836, 1.6403688514496881, 1.7216193476442248, 1.8039185334385515, 1.8872019461439096, 1.9714056484096216, 2.056466247620091, 2.1423209152918004, 2.2289074064703063, 2.3161640791272493, 2.404029913557339, 2.492444531775362, 2.5813482169131796, 2.670681932616721, 2.760387342442991, 2.8504068292570603, 2.9406835146290713, 3.031161278231232, 3.1217847772348146, 3.2124994657071624, 3.303251614008677, 3.3939883281898267, 3.484657569388136, 3.5752081732251946, 3.6655898692036537, 3.755753300104212, 3.8456500413826387, 3.9352326205667496, 4.024454536653416, 4.113270279505571, 4.201635349249185, 4.289506275670294, 4.376840637611976, 4.463597082371358, 4.549735345096622, 4.635216268183983, 4.720001820674716, 4.804055117652131, 4.88734043963858, 4.969823251992468, 5.051470224305226, 5.132249249798334, 5.2121294647203085, 5.291081267743699, 5.369076339362103, 5.446087661287134, 5.522089535845454, 5.597057605375754, 5.670968871625751, 5.743801715149208, 5.81553591470289, 5.886152666643618, 5.955634604325222, 6.02396581749556, 6.091131871693528, 6.157119827646022, 6.22191826066498, 6.285517280044351, 6.347908548457104, 6.409085301352237, 6.469042366351748, 6.527776182647665, 6.585284820399026, 6.641568000128882, 6.696627112121304, 6.7504652358183606, 6.803087159217144, 6.85449939826675, 6.904710216265283, 6.953729643256856, 7.001569495428587, 7.048243394507594, 7.093766787158008, 7.138156964377954, 7.18143308089656, 7.223616174570956, 7.264729185783272, 7.304796976837633, 7.343846351357158, 7.381906073680968, 7.41900688826117, 7.455181539059874, 7.490464788946173, 7.524893439093155, 7.558506348374898, 7.591344452763464, 7.623450784725908, 7.654870492621267, 7.685650860097565, 7.715841325488806, 7.745493501211982, 7.774661193164063, 7.803400420119001, 7.831769433124723, 7.859828734900138, 7.887641099232134, 7.915271590372567, 7.942787582435274, 7.970258778793062, 7.997757231474712, 8.025357360561971, 8.053135973586565, 8.081172284927181, 8.109547935206475, 8.13834701068807, 8.167656062673553, 8.19756412689948, 8.22816274293436, 8.259545973575678, 8.29181042424686, 8.32505526239431, 8.359382236884379, 8.39489569740038, 8.431702613839576, 8.469912595710195, 8.509637911528406, 8.550993508215342, 8.59409703049408, 8.639068840286646, 8.686032036111019, 8.735112472478127, 8.786438779288837, 8.840142381230969, 8.896357517176282, 8.955221259577483, 9.016873533865217, 9.081457137845067, 9.149117761094567, 9.220004004360176, 9.294267398954299, 9.37206242615227, 9.453546536589363, 9.538880169657787, 9.628226772903682, 9.721752821424115, 9.819627837264088, 9.922024408813527, 10.029118210204299, 10.14108802070718, 10.258115744128887, 10.380386428209047, 10.50808828401722, 10.64141270534989, 10.780554288127455, 10.925710849791233, 11.077083448700465, 11.234876403529308, 11.399297312663837, 11.570557073599039, 11.748869902335812, 11.934453352777975, 12.127528336129249, 12.32831914029028, 12.537053449255605, 12.753962362510686, 12.97928041442888, 13.213245593668448, 13.456099362569573, 13.708086676551327, 13.969456003508688, 14.24045934320953, 14.52135224669163, 14.812393835659673, 15.113846821882236, 15.425977526588783, 15.749055899866688, 16.083355540058207, 16.42915371315749, 16.786731372207594},
    .upper = 1.0 
};




REAL map_t_for_given_x(REAL x){
    if (x >= err_index_map_table.upper) {
        return err_index_map_table.y[MAP_N - 1];
    }
    int index = (x / err_index_map_table.upper) * (MAP_N - 1);
    while (err_index_map_table.x[index] > x) {
        index--;
    }
    while (err_index_map_table.x[index + 1] < x) {
        index++;
    }
    REAL t =  (x - err_index_map_table.x[index]) / (err_index_map_table.x[index + 1] - err_index_map_table.x[index]);
    t = err_index_map_table.y[index] + t * (err_index_map_table.y[index + 1] - err_index_map_table.y[index]);
    return t;
}

REAL map_out_for_given_t(REAL t){
    if (t >= index_out_map_table.upper) {
        return index_out_map_table.y[MAP_N - 1];
    }
    int index = (t / index_out_map_table.upper) * (MAP_N - 1);
    while (index_out_map_table.x[index] > t) {
        index--;
    }
    while (index_out_map_table.x[index + 1] < t) {
        index++;
    }
    REAL y =  (t - index_out_map_table.x[index]) / (index_out_map_table.x[index + 1] - index_out_map_table.x[index]);
    y = index_out_map_table.y[index] + y * (index_out_map_table.y[index + 1] - index_out_map_table.y[index]);
    return y;
}
/**
 * @brief Calculates the point on the Bezier curve at the given parameter t
 * @param t The parameter value
 * @param BezierController The Bezier controller
 * @return The point on the Bezier curve
 */
Point bezier(const REAL *t, const BezierController *BzierController)
{
    Point re = {0.0, 0.0};
    int i;
    REAL POW1 = 1.0;
    REAL POW2[10];
    POW2[0] = 1.0;
    for (i = 1; i < BEZIER_NUMBER_OF_POINTS; i++)
    {
        POW2[i] = POW2[i - 1] * (1 - *t);
    }
    for (i = 0; i < BEZIER_NUMBER_OF_POINTS; i++)
    {
        re.x += BzierController->points[i].x * Comb(BEZIER_NUMBER_OF_POINTS - 1, i) * POW1 * POW2[BEZIER_NUMBER_OF_POINTS - 1 - i];
        re.y += BzierController->points[i].y * Comb(BEZIER_NUMBER_OF_POINTS - 1, i) * POW1 * POW2[BEZIER_NUMBER_OF_POINTS - 1 - i];
        POW1 *= (*t);
    }
    // for (i = 0; i < BEZIER_NUMBER_OF_POINTS; i++)
    // {
    //     re.x += BzierController->points[i].x * (REAL)Comb(BEZIER_NUMBER_OF_POINTS - 1, i) * powf(1 - *t, BEZIER_NUMBER_OF_POINTS - 1 - i) * powf(*t, i);
    //     re.y += BzierController->points[i].y * (REAL)Comb(BEZIER_NUMBER_OF_POINTS - 1, i) * powf(1 - *t, BEZIER_NUMBER_OF_POINTS - 1 - i) * powf(*t, i);
    // }
    return re;
}

/**
 * @brief Calculates the x-coordinate on the Bezier curve at the given parameter t
 * @param t The parameter value
 * @param BezierController The Bezier controller
 * @return The x-coordinate on the Bezier curve
 */
REAL bezier_x(const REAL *t, const BezierController *BzierController)
{
    return bezier(t, BzierController).x;
}

/**
 * @brief Calculates the y-coordinate on the Bezier curve at the given parameter t
 * @param t The parameter value
 * @param BezierController The Bezier controller
 * @return The y-coordinate on the Bezier curve
 */
REAL bezier_y(const REAL *t, const BezierController *BzierController)
{
    return bezier(t, BzierController).y;
}

/**
 * Calculates the difference between the x-coordinate of a point on a Bezier curve
 * and a target x-coordinate.
 *
 * @param t The parameter value of the Bezier curve.
 * @param params A pointer to the FindTParams struct containing the BezierController and target_x.
 * @return The difference between the x-coordinate of the Bezier curve point and the target x-coordinate.
 */
REAL bezier_x_diff(REAL t, void *params)
{
    FindTParams *p = (FindTParams *)params;
    REAL bezier_x_val = bezier_x(&t, p->BzierController);
    return bezier_x_val - p->target_x;
}

/**
 * @brief Finds the parameter t for the given x-coordinate on the Bezier curve
 * @param x The x-coordinate
 * @param BezierController The Bezier controller
 * @return The parameter t
 */
REAL find_t_for_given_x(const REAL x, const BezierController *BzierController)
{
    FindTParams params;
    params.BzierController = BzierController;
    params.target_x = x;
    scipy_zeros_info solver_stats;
    REAL root = brentq(bezier_x_diff, 0.0f, 1.0f, &solver_stats, &params);
    if (solver_stats.error_num != CONVERGED)
    {
#if PC_SIMULATION
        printf("Error: %d\n", solver_stats.error_num);
#endif
    }
    return root;
}

/**
 * @brief Finds the y-coordinate on the Bezier curve for the given x-coordinate
 * @param x The x-coordinate
 * @param BezierController The Bezier controller
 * @return The y-coordinate on the Bezier curve
 */
REAL find_y_for_given_x(const REAL x, const BezierController *BzierController)
{
    REAL t = find_t_for_given_x(x, BzierController);
    return bezier_y(&t, BzierController);
}

/**
 * @brief Initial the control points for the Bezier curve
 * @param BezierController The Bezier controller
 */
// #include <errno.h>
#ifndef ARGS_PATH
#define ARGS_PATH "../args.txt"
#endif
void set_points(BezierController *BzierController)
{

    int i;

    // int terminal = 4;
    // REAL x_tmp[10]= {0.00000, 167.19914134825365, 684.6302061302766, 79.7836670190831,0,0,0,0,0,0};
    // REAL y_tmp[10]= {0.00000, 44.6915324901932, 79.7836670190831, 143.94129962856175,0,0,0,0,0,0};
    // REAL x_tmp[10] = {0, 0.0015036187833379713, 0.02421162125777866, 0.011573628570659907, 0.2351940203872609, 0, 0, 0, 0, 0};
    // REAL y_tmp[10] = {0, 0.06831889454002364, 0.7855265180918924, 0.3982552801401638, 9.004200761259638, 0, 0, 0, 0, 0};
    // REAL x_tmp[] = {0, 0.001483522141517538, 0.3925131729155844, 4.055584989134949, 0.7597112568584444, 5.152056419843189};
    // REAL y_tmp[] = {0, 4.894113784453421, 4.969405552328565, 0.3448187910584064, 8.039303402140806, 9.006185362086445};

#if FALSE // 动态分配 points 的内存
    BEZIER_NUMBER_OF_POINTS = sizeof(x_tmp) / sizeof(x_tmp[0]);
    BzierController->order = BEZIER_NUMBER_OF_POINTS - 1;
#if PC_SIMULATION
    printf("num_points: %d\n", BEZIER_NUMBER_OF_POINTS);
#endif
    BzierController->points = realloc(BzierController->points, sizeof(Point) * BEZIER_NUMBER_OF_POINTS);
#else
    BzierController->order = d_sim.user.bezier_order;
#if PC_SIMULATION
    REAL x_tmp[BEZIER_NUMBER_OF_POINTS];
    REAL y_tmp[BEZIER_NUMBER_OF_POINTS];
    FILE *fw;
    fw = fopen(ARGS_PATH, "r");
    if (fw == NULL)
    {
#if PC_SIMULATION
        printf("Error opening file!\n");
#endif
        exit(1);
    }
    printf("Bezier control points:\n");
    for (i = 0; i < BEZIER_NUMBER_OF_POINTS; ++i)
    {
        if (fscanf(fw, "%f,%f\n", &x_tmp[i], &y_tmp[i]) != 2)
        {
#if PC_SIMULATION
            printf("Error reading line %d\n", i + 1);
#endif
            exit(1);
        }
#if PC_SIMULATION
        printf("\t%d, %lf %lf\n", i, x_tmp[i], y_tmp[i]);
#endif
    }
    fclose(fw); // 关闭文件
#else
    SIM_2_EXP_DEFINE_BEZIER_POINTS_X
    SIM_2_EXP_DEFINE_BEZIER_POINTS_Y
#endif
    for (i = 0; i < BEZIER_NUMBER_OF_POINTS; ++i)
    {
        BzierController->points[i].x = x_tmp[i];
        BzierController->points[i].y = y_tmp[i];
    }
#endif
    // if (BzierController->points == NULL)
    // {
    //     errno = ENOMEM;
    //     return;
    // }
}

/**
 * @brief Calculates the control output using Bezier curve interpolation
 * @param r The PID regulator
 * @param BziController The Bezier controller
 */

void control_output(st_pid_regulator *r, BezierController *BziController)
{
    r->Err = r->Ref - r->Fbk;
    REAL error = r->Err;// * RPM_2_MECH_RAD_PER_SEC;
    // #if PC_SIMULATION printf("error: %lf\n", error); #endif
    #ifndef Bezier_table
    if (fabsf(error) > BziController->points[BziController->order].x)
    {
        error = copysignf(BziController->points[BziController->order].x, error);
    }
    #endif
    // #if PC_SIMULATION printf("error after Bezier: %lf\n", error); #endif
    REAL out;
    REAL fabsERR = fabs(error);
    REAL fabsfERR = fabsf(error);
    #ifdef Bezier_table
    out = map_out_for_given_t(map_t_for_given_x(fabsf(error)));
    #else
    out = find_y_for_given_x(fabsf(error), BziController);
    #endif
    r->OutPrev = r->Out;
    // r->Out = out*( error / (error + 1e-7) );
    r->Out = copysignf(out, error);
    // #if PC_SIMULATION printf("%.1f, %.1f\t", BziController.points[BziController.num_points].x, sign(error)); #endif
    // #if PC_SIMULATION printf("%.1f, %.1f, %.1f\t", r->Out, r->OutLimit, out); #endif
    // #if PC_SIMULATION printf("%.1f, %.1f, %.1f\n", r->Err, r->Ref, r->Fbk); #endif
    r->ErrPrev = r->Err;
    if (r->Out > r->OutLimit)
        r->Out = r->OutLimit;
    else if (r->Out < -r->OutLimit)
        r->Out = -r->OutLimit;
}
